<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WinGo Predictor Pro â€” Premium (Soft / Money Magnet)</title>
<meta name="theme-color" content="#0b1116"/>
<meta name="description" content="WinGo Predictor Pro - enhanced UI, Soft/Money Magnet decisions, processing spinner with $ icon, history-aware confidence"/>

<!-- Single-file premium UI + logic -->
<style>
/* ===== Root palette & reset ===== */
:root{
  --bg:#071018; --bg-2:#061016;
  --panel:#0d1722; --panel-2:#07101a; --panel-3:#051018;
  --text:#e9f6ff; --muted:#90abc6;
  --gold1:#ffe9a3; --gold2:#f6c44b; --gold3:#f0a800;
  --accent-cyan:#12b7e0; --accent-teal:#12dfb8;
  --green:#18c26e; --violet:#8b5cf6; --red:#e95555;
  --outline: rgba(255,255,255,0.06);
  --glass: rgba(255,255,255,0.02);
  --shadow: 0 20px 50px rgba(0,0,0,0.55);
  --r-xl:20px; --r-lg:14px; --r-md:10px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0; font-family:Inter, "Segoe UI", system-ui, -apple-system, sans-serif;
  background:
    radial-gradient(900px 500px at 80% -10%, rgba(20,40,60,0.12), transparent 8%),
    linear-gradient(180deg,#051016,#04060a);
  color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.container{max-width:1100px;margin:18px auto;padding:0 14px}

/* ===== Header (gold pill BDG look) ===== */
.header{
  position:relative;padding:14px 18px;border-radius:999px;text-align:center;font-weight:900;color:#211702;
  background:linear-gradient(180deg,var(--gold1),var(--gold2) 55%,var(--gold3));
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), 0 14px 50px rgba(240,170,40,0.18);
  margin-bottom:16px;
}
.header .shine{position:absolute;inset:0;opacity:.22;pointer-events:none;background:url("https://media.giphy.com/media/l0HlGJcX4zFbhWgW8/giphy.gif") center/cover no-repeat;mix-blend-mode:screen}

/* ===== Card ===== */
.card{
  background: linear-gradient(180deg,var(--panel),var(--panel-2));
  border-radius:var(--r-xl); padding:14px; margin-bottom:12px; border:1px solid var(--outline);
  box-shadow:var(--shadow);
}
.card h3{margin:0 0 10px;font-size:1.02rem;color:#e6f2ff}
.label{color:var(--muted);font-size:.9rem;margin-bottom:8px}
.note{color:#9fbad8;font-size:.87rem}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace}

/* ===== Input / Buttons ===== */
.input, .select {
  width:100%; padding:10px 12px; border-radius:12px; background:#07131b; border:1px solid var(--outline); color:var(--text);
}
.btn{padding:10px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:900}
.btn.primary{background:linear-gradient(180deg,var(--accent-teal),var(--accent-cyan)); color:#031616; box-shadow:0 8px 28px rgba(18,200,170,0.12)}
.btn.ghost{background:transparent;border:1px solid var(--outline);color:var(--text)}
.btn.gold{background:linear-gradient(180deg,var(--gold1),var(--gold2)); color:#231a02}
.btn.warn{background:linear-gradient(180deg,#ffd86b,#f6c44b); color:#2b1701}

/* Check button special */
#btnCheck{min-width:150px;background:linear-gradient(180deg,#7b56f2,#5a3fe0); color:white; transition:box-shadow .12s, transform .06s, background .12s}
#btnCheck.toggled{ background: linear-gradient(180deg,#ffe9a3,#f6c44b); color:#201600; box-shadow:0 10px 30px rgba(240,170,40,0.18) }

/* ===== Layout helpers ===== */
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid2{display:grid;grid-template-columns:1.4fr .9fr;gap:12px}
@media (max-width:820px){ .grid2{grid-template-columns:1fr} }

/* ===== Tabs ===== */
.tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
.tab-btn{padding:12px;border-radius:12px;background:#08181f;border:1px solid var(--outline);cursor:pointer;font-weight:800}
.tab-btn.active{background:#0b2430;border-color:#13d6b1;box-shadow:inset 0 0 0 4px rgba(19,214,177,0.08)}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* ===== Probability bars ===== */
.bars{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;height:170px;align-items:end}
.bar{position:relative;border-radius:10px;background:#071823;border:1px solid #0f2936;overflow:hidden}
.bar-fill{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(180deg,#12e6bf,#12a8e6);box-shadow:inset 0 -8px 18px rgba(255,255,255,0.06)}
.bar small{position:absolute;bottom:-18px;width:100%;text-align:center;color:var(--muted)}

/* ===== Predictions list ===== */
.pred-row{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:10px;border-radius:12px;background:linear-gradient(180deg,#07161b,#06101a);border:1px solid var(--outline);margin-bottom:8px}
.chip{padding:6px 10px;border-radius:999px;font-weight:900;display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03)}
.chip.soft{color:#10c48f;background:rgba(16,196,143,0.08);border:1px solid rgba(16,196,143,0.14)}
.chip.money{color:#ffd76b;background:rgba(255,215,107,0.10);border:1px solid rgba(255,215,107,0.14)}

/* ===== Patterns ===== */
.pattern-line{display:flex;flex-wrap:wrap;gap:8px}
.p-pill{padding:6px 10px;border-radius:999px;background:#07121a;border:1px solid var(--outline);font-weight:800}
.p-bg{color:#ffe173} .p-sm{color:#84b8ff}
.p-green{color:#99f1d0} .p-red{color:#ffb4b4}

/* ===== Stats ===== */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media (max-width:980px){ .stat-grid{grid-template-columns:repeat(2,1fr)} }
.stat{padding:12px;border-radius:12px;background:#0b1620;border:1px solid var(--outline)}
.stat h4{margin:0;color:#dbeffd}
.stat .v{font-size:1.3rem;font-weight:900;margin-top:6px}
.progress{height:8px;border-radius:999px;background:#07121a;border:1px solid #0d2430;overflow:hidden}
.progress > span{display:block;height:100%;background:linear-gradient(90deg,#12dfb8,#12a9e6)}

/* ===== Processing spinner (dollar icon) ===== */
.processing{
  display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:linear-gradient(180deg,#06121a,#041018);border:1px solid var(--outline)
}
.spin{
  width:40px;height:40px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,#0f1b23,#071018);position:relative;overflow:hidden;
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
}
.spin .ring{position:absolute;inset:0;border-radius:50%;border:3px solid rgba(255,255,255,0.03);animation:spin 1.1s linear infinite}
.spin .dollar{position:relative;font-weight:900;font-size:18px;color:#ffd86b}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* ===== Result box styling ===== */
.result-box{background:linear-gradient(180deg,#07131a,#041018); border-radius:12px; padding:12px; border:1px solid var(--outline)}
.result-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
.result-row:last-child{border-bottom:0}
.result-key{color:var(--muted);font-weight:700}
.result-val{font-weight:900}

/* ===== Toast ===== */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:10px 14px;border-radius:12px;background:#06121a;border:1px solid var(--outline);box-shadow:var(--shadow);z-index:9999}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="shine"></div>
    <span style="margin-right:10px;display:inline-block;width:11px;height:11px;background:#0b0f13;border-radius:50%;border:2px solid rgba(0,0,0,0.12)"></span>
    <span>WINGO PREDICTOR PRO</span>
  </div>

  <!-- Controls -->
  <div class="card">
    <h3>âš™ï¸ Controls</h3>
    <div class="grid2">
      <div>
        <div class="label">LIVE_API_URL (GitHub Raw / Your HTTPS API)</div>
        <input id="apiUrl" class="input mono" placeholder="https://raw.githubusercontent.com/you/repo/branch/history.json"/>
      </div>
      <div class="row" style="align-items:flex-end">
        <button id="btnConnect" class="btn primary" style="min-width:150px">Connect API</button>
        <button id="btnSample" class="btn ghost" style="min-width:120px">Load Sample</button>
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div style="flex:1 1 320px">
        <div class="label">Strategy</div>
        <select id="strategy" class="select">
          <option value="balanced" selected>Balanced (â­ High â‰¥ 0.75)</option>
          <option value="conservative">Conservative (â­ High â‰¥ 0.82)</option>
          <option value="aggressive">Aggressive (â­ High â‰¥ 0.68)</option>
          <option value="custom">Customâ€¦</option>
        </select>
      </div>
      <div style="flex:1 1 180px">
        <div class="label">High Threshold (0.50â€“0.95)</div>
        <input id="thHigh" type="number" class="input" min="0.5" max="0.95" step="0.01" value="0.75"/>
      </div>
      <div style="flex:1 1 140px">
        <div class="label">Auto-Refresh / Auto Predict</div>
        <select id="autoRefresh" class="select">
          <option value="0" selected>Off</option>
          <option value="30">Every 30s</option>
          <option value="60">Every 60s</option>
        </select>
      </div>
      <div style="flex:0 0 120px;align-self:flex-end">
        <button id="btnApply" class="btn primary" style="width:100%">Apply</button>
      </div>
      <div class="pill" style="align-self:flex-end;padding:8px 12px;gap:8px">
        Live: <strong id="liveState">Off</strong>
      </div>
    </div>
    <div class="note" style="margin-top:8px">Tip: à¤†à¤ª GitHub raw JSON à¤¡à¤¾à¤²à¥‡à¤‚ â€” history à¤µà¤¹à¤¾à¤ à¤¸à¥‡ à¤²à¥‡à¤‚à¤—à¥‡à¥¤ à¤¯à¤¦à¤¿ API à¤¨ à¤¦à¥‡à¤‚ à¤¤à¥‹ sample local à¤°à¤¹à¥‡à¤—à¤¾à¥¤</div>
  </div>

  <!-- Check by Period -->
  <div class="card">
    <h3>ğŸ” Check by Period</h3>
    <div class="row">
      <input id="periodInput" class="input mono" placeholder="Enter Period Number (e.g. 20250814100051634 or short like 51653)"/>
      <button id="btnCheck" class="btn" title="Tap to check">Check</button>
    </div>
    <div id="periodError" class="note" style="color:var(--red);margin-top:8px;display:none"></div>

    <div style="margin-top:12px" class="grid2">
      <div class="card" style="margin:0">
        <h3>Result</h3>
        <div class="result-box">
          <div class="result-row"><div class="result-key">Input</div><div class="result-val mono" id="res-input">â€”</div></div>
          <div class="result-row"><div class="result-key">Using period</div><div class="result-val mono" id="res-period">â€”</div></div>
          <div class="result-row"><div class="result-key">Digit</div><div class="result-val mono" id="res-digit">â€”</div></div>
          <div class="result-row"><div class="result-key">Type</div><div class="result-val mono" id="res-type">â€”</div></div>
          <div class="result-row"><div class="result-key">Color</div><div class="result-val mono" id="res-color">â€”</div></div>
          <div class="result-row"><div class="result-key">Confidence</div><div class="result-val mono" id="res-conf">â€”</div></div>
          <div class="result-row"><div class="result-key">Decision</div><div class="result-val" id="res-decision"><span class="chip">â€”</span></div></div>
        </div>
      </div>
      <div class="card" style="margin:0">
        <h3>About</h3>
        <div class="note">
          â€¢ Period â†’ stable hash â†’ <b>digit (0â€“9)</b>.<br/>
          â€¢ digit â‰¥5 â‡’ <b>Big</b>, else <b>Small</b>.<br/>
          â€¢ Color parity uses hash bits; results vary by period.<br/>
          â€¢ Confidence is history-aware (frequency + recency + entropy + shrinkage).<br/>
          â€¢ Decisions now ONLY: <span class="chip soft">Soft ğŸ’š</span> or <span class="chip money">Money Magnet ğŸ§²</span>.
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab-btn active" data-tab="tab-prob">Probability</div>
    <div class="tab-btn" data-tab="tab-preds">Predictions</div>
    <div class="tab-btn" data-tab="tab-patterns">Patterns</div>
    <div class="tab-btn" data-tab="tab-stats">Stats</div>
  </div>

  <!-- Probability -->
  <div id="tab-prob" class="tab-pane active">
    <div class="card">
      <h3>ğŸ“Š Probability (0â€“9) <span class="note" id="probSource">(from history)</span></h3>
      <div class="bars" id="probBars"></div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div class="note">Top: <span id="probTop" class="mono">â€”</span></div>
        <div class="note">Bottom: <span id="probBottom" class="mono">â€”</span></div>
      </div>
      <div style="margin-top:10px" class="card" id="probCanvasWrap"><canvas id="probCanvas" height="140" style="width:100%"></canvas></div>
      <div class="note" style="margin-top:6px">Bar heights API/Sample à¤ªà¤° depend à¤¹à¥ˆà¤‚; smoothing à¤²à¤—à¤¾à¤ˆ à¤—à¤¯à¥€ à¤¹à¥ˆà¥¤</div>
    </div>
  </div>

  <!-- Predictions -->
  <div id="tab-preds" class="tab-pane">
    <div class="card">
      <h3>ğŸ•’ Recent Predictions</h3>
      <div id="predList"></div>
    </div>
  </div>

  <!-- Patterns -->
  <div id="tab-patterns" class="tab-pane">
    <div class="card"><h3>ğŸ§© Big/Small Pattern</h3><div id="patBS" class="pattern-line"></div></div>
    <div class="card"><h3>ğŸŸ¢ğŸ”´ Color Pattern</h3><div id="patCR" class="pattern-line"></div></div>
    <div class="row">
      <div class="card" style="flex:1"><h3>ğŸ”¥ Hot</h3><div id="hotList" class="pattern-line"></div></div>
      <div class="card" style="flex:1"><h3>â„ï¸ Cold</h3><div id="coldList" class="pattern-line"></div></div>
    </div>
    <div class="card"><h3>ğŸ“ Gap Heatmap (Last 40)</h3><div id="gapMap" class="pattern-line"></div></div>
  </div>

  <!-- Stats -->
  <div id="tab-stats" class="tab-pane">
    <div class="card">
      <h3>ğŸ“ˆ Stats Overview</h3>
      <div class="stat-grid">
        <div class="stat"><h4>Total Records</h4><div class="v mono" id="st-total">â€”</div></div>
        <div class="stat"><h4>Money Magnet Rate</h4><div class="v mono" id="st-mm">â€”</div><div class="progress"><span id="st-mm-p" style="width:0%"></span></div></div>
        <div class="stat"><h4>Avg Confidence</h4><div class="v mono" id="st-avg">â€”</div><div class="progress"><span id="st-avg-p" style="width:0%"></span></div></div>
        <div class="stat"><h4>Top Digit (Hit%)</h4><div class="v mono" id="st-top">â€”</div></div>
      </div>
    </div>
    <div class="card"><h3>ğŸ“Š Distribution</h3><div class="canvas-wrap"><canvas id="distCanvas" height="160" style="width:100%"></canvas></div></div>
  </div>

  <div style="height:36px"></div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"><div id="toastText">Loaded</div></div>

<script>
/* ================= Utilities ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const clamp = (v,mx,mn) => Math.max(mx,Math.min(mn,v));
const toast = (t,ms=1400) => { const el=$("#toast"); $("#toastText").textContent=t; el.classList.remove("hidden"); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.add("hidden"), ms); };

/* ===== stable hash (FNV1a-like) ===== */
function fnv1a(str){
  let h=0x811c9dc5>>>0;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h ^ (h >>> 16), 0x45d9f3b) >>> 0;
    h = (h + ((h<<3)>>>0) + ((h<<7)>>>0)) >>> 0;
  }
  return h>>>0;
}
function periodDigit(period){ return fnv1a(String(period)) % 10; }
function digitColor(d,period){ const h=fnv1a(String(period)); const parity = ((h>>>3)^(h>>>7)^(h>>>11)) & 1; return ((d%2)^parity) ? "Red" : "Green"; }

/* ===== improved confidence calculation (history-aware) ===== */
function baseConf(d,period){
  const h = fnv1a(String(period)+'#'+d);
  return 0.62 + ((h & 1023)/1023)*0.28; // 0.62..0.90
}
function computeConfidence(d,period,history){
  const base = baseConf(d,period);
  let freq = 0;
  for(let i=0;i<history.length;i++){ if(history[i].num===d) freq++; }
  const total = history.length || 1; const rate = freq/total;
  // frequency adjustment
  let freqAdj = 0;
  if(rate < 0.06) freqAdj = 0.06;
  else if(rate < 0.12) freqAdj = 0.03;
  else if(rate > 0.25) freqAdj = -0.04;
  // recency penalty: if seen in last 3 positions penalize more
  const lastIdx = history.findIndex(h=>h.num===d);
  let recPenalty = 0;
  if(lastIdx !== -1){
    if(lastIdx <= 2) recPenalty = 0.06;
    else if(lastIdx <= 6) recPenalty = 0.03;
  }
  // entropy tweak from hash
  const hv = (fnv1a(String(period)+'v') & 255)/255;
  const entropyAdj = (hv - 0.5) * 0.06;
  let raw = base + freqAdj - recPenalty + entropyAdj;
  // shrinkage toward prior to avoid overconfidence with small history
  const prior = 0.72; const N = Math.min(60, total);
  const k = 7; const alpha = N/(N+k);
  const final = alpha*raw + (1-alpha)*prior;
  return Math.max(0.50, Math.min(0.95, final));
}

/* ===== strategies ===== */
const strategies = { balanced:{high:0.75}, conservative:{high:0.82}, aggressive:{high:0.68}, custom:{high:0.75} };

/* ===== state ===== */
const state = {
  apiUrl:"",
  history:[],
  probs:new Array(10).fill(0),
  high: strategies.balanced.high,
  autoTimer:null,
  autoSec:0
};

/* ===== normalize history ===== */
function normalizeHistory(arr){
  const out=[];
  (arr||[]).forEach((r,i)=>{
    const period = r.period ?? (1000+i);
    const num = Number.isInteger(r.num) ? clamp(r.num,0,9) : periodDigit(period);
    const type = r.type ?? (num>=5?"Big":"Small");
    const color = r.color ?? digitColor(num,period);
    const conf = (typeof r.confidence==="number") ? Math.max(0.5, Math.min(0.95, r.confidence)) : computeConfidence(num,period,out);
    const ts = r.ts ?? (Date.now() - i*60000);
    out.push({period,num,type,color,confidence:conf,ts});
  });
  return out;
}

/* ===== fetch API helper ===== */
async function fetchApi(url){ const res = await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error(res.status+" "+res.statusText); return await res.json(); }

/* ===== bind controls ===== */
function bindControls(){
  $("#btnSample").addEventListener("click", loadSample);
  $("#btnConnect").addEventListener("click", async ()=>{
    const url = $("#apiUrl").value.trim(); if(!url){ toast("Paste LIVE_API_URL"); return; }
    try{
      toast("Fetching API...");
      const json = await fetchApi(url);
      state.history = normalizeHistory(json.history || json || []);
      updateProbabilities(); renderAll();
      $("#probSource").textContent="(from API)";
      toast("API connected âœ“");
    }catch(e){ console.error(e); toast("API load failed"); }
  });

  $("#btnApply").addEventListener("click", ()=>{
    const strat = $("#strategy").value; state.high = parseFloat($("#thHigh").value) || strategies[strat].high;
    const ar = parseInt($("#autoRefresh").value,10)||0;
    setAuto(ar);
    renderLiveBadge();
    toast("Settings applied âœ“");
  });

  // Check button: toggle visual and run check
  $("#btnCheck").addEventListener("click", async ()=>{
    // toggle yellow state briefly
    const btn = $("#btnCheck"); btn.classList.add("toggled");
    setTimeout(()=>btn.classList.remove("toggled"), 250);
    const p = $("#periodInput").value.trim();
    if(!p){ $("#periodError").style.display="block"; $("#periodError").textContent="Please enter a period number."; return; }
    $("#periodError").style.display="none";
    // show 3s processing spinner before computing
    await showProcessing(3000);
    const out = checkByPeriod(p);
    // push into history as newest
    state.history.unshift({period:out.period,num:out.digit,type:out.type,color:out.color,confidence:out.conf,ts:Date.now()});
    // cap history
    if(state.history.length > 600) state.history = state.history.slice(0,600);
    updateProbabilities(); renderAll(); renderCheck(out);
  });

  // tabs
  $$(".tab-btn").forEach(b => b.addEventListener("click", ()=> switchTab(b.dataset.tab)));

  // shortcuts
  window.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#periodInput").focus(); }
    if(e.key==="r"){ e.preventDefault(); manualRefresh(); }
    if(e.key==="a"){ e.preventDefault(); toggleAuto(); }
    if(["1","2","3","4"].includes(e.key)){ e.preventDefault(); switchTab(["tab-prob","tab-preds","tab-patterns","tab-stats"][Number(e.key)-1]); }
  });
}

/* ===== show processing for ms milliseconds (spinner with $) ===== */
function showProcessing(ms=3000){
  return new Promise(res=>{
    // create overlay-style small processing card near Check
    const proc = document.createElement("div"); proc.className="processing"; proc.id="procTemp";
    proc.innerHTML = `<div class="spin"><div class="ring"></div><div class="dollar">$</div></div><div class="note" style="font-weight:800">Processing</div>`;
    // attach after btnCheck
    const wrap = $("#btnCheck").parentNode; wrap.appendChild(proc);
    setTimeout(()=>{ proc.remove(); res(); }, ms);
  });
}

/* ===== period mapping and check ===== */
function checkByPeriod(input){
  const s = String(input).replace(/\D/g,"");
  const period = s.length >= 4 ? s : ("000000"+s).slice(-6);
  const d = periodDigit(period);
  const type = d >= 5 ? "Big" : "Small";
  const color = digitColor(d,period);
  const conf = computeConfidence(d,period,state.history);
  return {input, period: Number(period), digit: d, type, color, conf};
}

/* ===== render result - decision only Soft or Money Magnet ===== */
function renderCheck(res){
  $("#res-input").textContent = res.input;
  $("#res-period").textContent = res.period;
  $("#res-digit").textContent = "#"+res.digit;
  $("#res-type").textContent = res.type;
  $("#res-color").textContent = res.color;
  $("#res-conf").textContent = (res.conf*100).toFixed(1) + "%";
  // decision: only 2 categories
  const dst = document.getElementById("res-decision");
  const node = document.createElement("div");
  const tag = (res.conf >= state.high) ? `<div class="chip money">Money Magnet ğŸ§²</div>` : `<div class="chip soft">Soft ğŸ’š</div>`;
  node.innerHTML = tag;
  dst.parentNode.replaceChild(node.firstElementChild, dst);
}

/* ===== probabilities ===== */
function updateProbabilities(){
  const counts = new Array(10).fill(0);
  state.history.forEach(h => counts[h.num] = (counts[h.num]||0)+1);
  const total = Math.max(1, state.history.length);
  state.probs = counts.map(c => c/total);
}
function renderBars(){
  const box = $("#probBars"); box.innerHTML="";
  const max = Math.max(...state.probs,0.01);
  state.probs.forEach((p,i)=>{
    const el = document.createElement("div"); el.className="bar";
    el.innerHTML = `<div class="bar-fill" style="height:${(p/max)*100}%"></div><small>${i}</small>`;
    box.appendChild(el);
  });
  const sorted = state.probs.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v);
  $("#probTop").textContent = `${sorted[0].i} (${(sorted[0].v*100).toFixed(1)}%)`;
  $("#probBottom").textContent = `${sorted[sorted.length-1].i} (${(sorted[sorted.length-1].v*100).toFixed(1)}%)`;
  // canvas spark
  const canvas = $("#probCanvas"); const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth, h = canvas.height;
  ctx.clearRect(0,0,w,h);
  const pad = 12, bw = (w - pad*2)/10 - 6, base = h-22;
  ctx.font = "12px ui-monospace, monospace";
  state.probs.forEach((p,i)=>{
    const x = pad + i*(bw+6), bh = Math.max(4, p*h*0.85), y = base - bh;
    const g = ctx.createLinearGradient(0,y,0,y+bh); g.addColorStop(0,"#12dfb8"); g.addColorStop(1,"#12a8e6");
    ctx.fillStyle = g; ctx.fillRect(x,y,bw,bh);
    ctx.strokeStyle = "#082a32"; ctx.strokeRect(x,y,bw,bh);
    ctx.fillStyle = "#9fc0d8"; ctx.fillText(String(i), x + bw/2 - 4, h - 6);
  });
}

/* ===== predictions list ===== */
function renderPredictions(){
  const wrap = $("#predList"); wrap.innerHTML="";
  const show = state.history.slice(0,30);
  show.forEach(h=>{
    const row = document.createElement("div"); row.className="pred-row";
    const time = new Date(h.ts).toLocaleTimeString();
    row.innerHTML = `<div class="mono">ğŸ•’ ${time}</div>
      <div class="mono">tail ${h.period} â†’ <b>#${h.num}</b> (${h.type}) â€¢ <span class="note">${h.color}</span></div>
      <div>${ h.confidence >= state.high ? '<span class="chip money">Money Magnet ğŸ§²</span>' : '<span class="chip soft">Soft ğŸ’š</span>'}</div>`;
    wrap.appendChild(row);
  });
}

/* ===== patterns ===== */
function renderPatterns(){
  const hist = state.history.slice(0,40);
  $("#patBS").innerHTML = ""; $("#patCR").innerHTML = "";
  hist.forEach(h=>{
    const p1 = document.createElement("div"); p1.className="p-pill"; p1.textContent = h.type; p1.classList.add(h.type==="Big"?"p-bg":"p-sm");
    $("#patBS").appendChild(p1);
    const p2 = document.createElement("div"); p2.className="p-pill"; p2.textContent = h.color; p2.classList.add(h.color==="Green"?"p-green":"p-red");
    $("#patCR").appendChild(p2);
  });
  // hot/cold
  const counts = new Array(10).fill(0); hist.forEach(h=>counts[h.num]++);
  const arr = counts.map((c,i)=>({i,c})).sort((a,b)=>b.c-a.c);
  $("#hotList").innerHTML = arr.slice(0,3).map(x=>`<div class="p-pill">${x.i} <span class="note">(${x.c})</span></div>`).join("");
  $("#coldList").innerHTML = arr.slice(-3).reverse().map(x=>`<div class="p-pill">${x.i} <span class="note">(${x.c})</span></div>`).join("");
  // gap map
  const lastSeen = new Map(); const gaps=[];
  hist.forEach((h, idx)=>{ const prev = lastSeen.get(h.num); const gap = prev==null ? "â€”" : (idx-prev); lastSeen.set(h.num, idx); gaps.push({num:h.num,gap}); });
  $("#gapMap").innerHTML = gaps.map(g=>`<div class="p-pill">#${g.num} <span class="note">gap:${g.gap}</span></div>`).join("");
}

/* ===== stats ===== */
function renderStats(){
  const hist = state.history; const total = hist.length;
  $("#st-total").textContent = String(total);
  const mm = hist.filter(h=>h.confidence >= state.high).length;
  const mmRate = total ? (mm/total) : 0; $("#st-mm").textContent = (mmRate*100).toFixed(1) + "%"; $("#st-mm-p").style.width = (mmRate*100) + "%";
  const avg = total ? (hist.reduce((a,b)=>a+b.confidence,0)/total) : 0; $("#st-avg").textContent = (avg*100).toFixed(1) + "%"; $("#st-avg-p").style.width = ((avg-0.5)/0.45*100) + "%";
  const counts = new Array(10).fill(0); hist.forEach(h=>counts[h.num]++);
  const top = counts.map((c,i)=>({i,c})).sort((a,b)=>b.c-a.c)[0] || {i:"â€”",c:0}; $("#st-top").textContent = `${top.i} (${ total ? (top.c/total*100).toFixed(1) : "0.0"}%)`;
  // dist canvas
  const canvas = $("#distCanvas"), ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth, h = canvas.height; ctx.clearRect(0,0,w,h);
  const pad = 12, bw = (w-pad*2)/10 - 6, base = h - 20, max = Math.max(...counts,1);
  ctx.font = "12px ui-monospace, monospace";
  counts.forEach((c,i)=>{ const x = pad + i*(bw+6), bh = Math.max(4, c/max*(h*0.82)), y = base - bh; ctx.fillStyle="#081423"; ctx.fillRect(x,y,bw,bh); ctx.strokeStyle="#102b38"; ctx.strokeRect(x,y,bw,bh); ctx.fillStyle="#9fbcd4"; ctx.fillText(String(i), x + bw/2 - 4, h - 6); });
}

/* ===== render all ===== */
function renderAll(){ updateProbabilities(); renderBars(); renderPredictions(); renderPatterns(); renderStats(); }

/* ===== auto predict (30s / 60s) ===== */
function setAuto(sec){
  if(state.autoTimer){ clearInterval(state.autoTimer); state.autoTimer=null; state.autoSec=0; }
  if(sec>0){
    state.autoSec = sec;
    state.autoTimer = setInterval(()=> {
      // increment current period input and auto-check
      const inp = $("#periodInput"); let cur = inp.value.trim(); if(!cur) cur = String(Date.now());
      const digits = cur.replace(/\D/g,"") || String(Date.now());
      let num = parseInt(digits,10) || Date.now();
      num = num + 1; inp.value = String(num);
      // visual toggle and check
      $("#btnCheck").classList.add("toggled"); setTimeout(()=>$("#btnCheck").classList.remove("toggled"),200);
      // show processing and run check
      (async ()=>{ await showProcessing(800 + Math.random()*400); const out = checkByPeriod(inp.value); state.history.unshift({period:out.period,num:out.digit,type:out.type,color:out.color,confidence:out.conf,ts:Date.now()}); if(state.history.length>600) state.history=state.history.slice(0,600); renderAll(); renderCheck(out); })();
    }, sec*1000);
  }
  renderLiveBadge();
}
function toggleAuto(){ if(state.autoTimer) { clearInterval(state.autoTimer); state.autoTimer=null; state.autoSec=0; $("#autoRefresh").value="0"; toast("Auto stopped"); } else { const s = parseInt($("#autoRefresh").value,10)||0; if(s>0) setAuto(s); } renderLiveBadge(); }
function renderLiveBadge(){ $("#liveState").textContent = state.autoTimer ? `On (${state.autoSec}s)` : "Off"; }

/* ===== manual refresh (API pull) ===== */
async function manualRefresh(silent=false){
  const url = $("#apiUrl").value.trim(); if(!url){ if(!silent) toast("Set LIVE_API_URL"); return; }
  try{
    if(!silent) toast("Refreshingâ€¦");
    const json = await fetchApi(url);
    state.history = normalizeHistory(json.history||json||[]);
    renderAll(); if(!silent) toast("Refreshed âœ“");
  }catch(e){ if(!silent) toast("Refresh failed"); console.error(e); }
}

/* ===== sample loader ===== */
function loadSample(){
  const sample = { history: [
    {period:20250814100051634,num:6,confidence:.76},
    {period:20250814100051633,num:8,confidence:.72},
    {period:20250814100051632,num:0,confidence:.68},
    {period:20250814100051631,num:8,confidence:.70},
    {period:20250814100051630,num:2,confidence:.73},
    {period:20250814100051629,num:5,confidence:.79},
    {period:20250814100051628,num:4,confidence:.64},
    {period:20250814100051627,num:6,confidence:.72},
    {period:20250814100051626,num:7,confidence:.86},
    {period:20250814100051625,num:3,confidence:.68},
    {period:20250814100051624,num:1,confidence:.65},
    {period:20250814100051623,num:9,confidence:.83},
    {period:20250814100051622,num:8,confidence:.77},
    {period:20250814100051621,num:0,confidence:.61},
    {period:20250814100051620,num:8,confidence:.68},
    {period:20250814100051619,num:2,confidence:.71},
    {period:20250814100051618,num:5,confidence:.80},
    {period:20250814100051617,num:4,confidence:.58},
    {period:20250814100051616,num:6,confidence:.73},
    {period:20250814100051615,num:7,confidence:.88}
  ]};
  state.history = normalizeHistory(sample.history);
  renderAll();
  $("#probSource").textContent="(from sample)";
  toast("Sample loaded âœ“");
}

/* ===== init ===== */
function init(){
  bindControls();
  loadSample();
  // show brief 3s spinner on page load to match request
  (async ()=>{
    await showProcessing(3000);
    renderAll();
  })();

  // default apply: set threshold from UI
  state.high = parseFloat($("#thHigh").value) || strategies.balanced.high;

  // tab initial
  $$(".tab-btn")[0].classList.add("active"); $$(".tab-pane")[0].classList.add("active");
}
init();

/* ===== simple helpers for external interaction ===== */
function decisionTag(conf){ return conf >= state.high ? `<span class="chip money">Money Magnet ğŸ§²</span>` : `<span class="chip soft">Soft ğŸ’š</span>`; }

</script>
</body>
</html>
