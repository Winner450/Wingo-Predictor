<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>🎯 WinGo Predictor Pro</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --gold:#ffd700; --gold-2:#f5d46b; --ink:#e5e7eb; --muted:#9ca3af;
  --card:#14161b; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --radius:16px; --shadow:0 12px 26px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(160deg,#0b0b0f,#000);color:#fff;font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto}

/* === Top Golden line (ONLY ONE BRAND) === */
.topgold{
  position:sticky; top:0; z-index:120;
  background:linear-gradient(90deg,#ffea80,#ffd700,#f5c400);
  color:#000; font-weight:900; letter-spacing:.3px;
  display:flex; align-items:center; justify-content:center;
  height:44px; padding:0 12px; box-shadow:0 2px 10px rgba(0,0,0,.35);
  text-transform:uppercase; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* Slim bar under brand (no logo text to avoid duplicate) */
header{position:sticky; top:44px; z-index:100; background:#000; border-bottom:1px solid #0f1117}
.bar{max-width:1180px;margin:0 auto;display:flex;align-items:center;justify-content:flex-end;padding:10px 16px}
.brand-placeholder{display:none} /* hide any extra brand */

/* Layout */
.container{max-width:1180px;margin:0 auto;padding:18px 16px 38px}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.section-title{font-size:16px;font-weight:800;margin:0 0 10px}
.sub{color:var(--muted);font-size:12px;margin-top:6px}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
label{font-size:13px;color:#d8dbe2;font-weight:700;margin-bottom:6px;display:block}
input,select{width:100%;padding:12px 14px;background:#0c0f14;border:2px solid #202636;border-radius:12px;color:#fff;font-size:16px;outline:none}
input:focus,select:focus{border-color:var(--gold)}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{background:linear-gradient(180deg,var(--gold),var(--gold-2));color:#000;font-weight:800;border:0;border-radius:12px;padding:12px 18px;cursor:pointer}
.btn.sec{background:#1e2636;color:#e5e7eb;border:1px solid #2a3448}
.switch{display:inline-flex;gap:8px;align-items:center;color:#e0e3ea;font-size:13px}
.chip{display:inline-flex;align-items:center;gap:8px;background:#0e121a;border:1px solid #1f2636;border-radius:999px;padding:8px 12px;color:#cfd4e1;font-weight:700}

.helper{font-size:12px;color:#9ca3af}
.hr{height:1px;background:#1a2130;margin:14px 0}

/* Result */
.kv{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){.kv{grid-template-columns:1fr}}
.box{background:#0b0f15;border:1px solid #1a2130;border-radius:14px;padding:14px}
.key{color:#a1a8b8;font-size:12px}.val{color:var(--gold);font-weight:900;font-size:30px}
.line{height:10px;background:#1c2534;border-radius:999px;overflow:hidden;margin:10px 0 2px}
.bar{height:10px;width:0%;background:linear-gradient(90deg,var(--gold-2),var(--gold))}
.pill{display:inline-block;border:1px solid #2a3448;border-radius:999px;padding:6px 10px;font-weight:800;margin-right:6px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.history{font-size:12px;color:#cfd4e1;max-height:220px;overflow:auto}
.hrow{padding:6px 0;border-bottom:1px dashed #21293a}

/* Radios neat */
.radios{display:flex;gap:18px;align-items:center}
.radios label{display:flex;gap:8px;align-items:center;font-weight:700}
</style>
</head>
<body>
<div class="topgold">🎯 WINGO PREDICTOR PRO</div>
<header>
  <div class="bar">
    <label class="switch"><input type="checkbox" id="compactToggle"> Compact View</label>
  </div>
</header>

<div class="container" id="appRoot">
  <div class="card">
    <div class="section-title">Quick Predict</div>

    <div class="grid">
      <div>
        <label for="period">🧾 Period Number</label>
        <input id="period" placeholder="e.g. 20250813100052810"/>
        <div class="sub">लम्बा period ID • केवल digits (0–9)</div>
      </div>
      <div>
        <label for="mode">Strategy</label>
        <select id="mode">
          <option value="balanced">Normal</option>
          <option value="conservative">Confidence</option>
          <option value="aggressive">Very Confident</option>
          <option value="beast" selected>💥 Beast Mode (best)</option>
        </select>
        <div class="row" style="margin-top:8px">
          <label class="switch"><input id="autoNext" type="checkbox"> Auto Next</label>
          <span class="chip"><span>⏱</span><input id="autoEvery" type="number" min="5" value="30" style="width:70px;background:transparent;border:0;color:#fff">sec</span>
          <label class="switch"><input id="antiSeq" type="checkbox" checked> Anti-sequence</label>
          <label class="switch"><input id="learnOn" type="checkbox" checked> Learning ON</label>
          <button class="btn sec" id="notifyBtn" type="button">🔔 Notifications</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnPredict" type="button">🔮 Predict</button>
      <button class="btn sec" id="btnClear"   type="button">Clear</button>
      <button class="btn sec" id="btnCopy"    type="button">Copy Result</button>
      <span class="helper" id="periodInfo">—</span>
    </div>

    <div class="hr"></div>

    <!-- Verify & Learn (Big/Small) -->
    <div class="section-title" style="margin-top:0">Verify & Learn</div>
    <div class="grid">
      <div>
        <label>✅ Actual size — optional (Learning)</label>
        <div class="radios">
          <label><input type="radio" name="actSize" value="small"> Small (0–4)</label>
          <label><input type="radio" name="actSize" value="big"> Big (5–9)</label>
        </div>
        <div class="sub">WIN पर हरा, LOSS पर लाल दिखेगा</div>
      </div>
      <div class="row" style="align-items:end">
        <button class="btn sec" id="btnVerify" type="button">Verify & Learn</button>
        <span class="helper" id="verifyMsg">—</span>
      </div>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card" id="resultCard" style="margin-top:14px;display:none">
    <div class="kv">
      <div class="box"><div class="key">🧾 Period</div><div class="val" id="vPeriod">—</div></div>
      <div class="box"><div class="key">🔢 Predicted Number</div><div class="val" id="vNum">—</div></div>
      <div class="box"><div class="key">📏 Size</div><div class="val" id="vSize">—</div></div>
    </div>
    <div style="margin-top:10px">
      <div class="key">🧠 Confidence <span id="hiAcc" class="chip" style="display:none">🔥 High Accuracy</span></div>
      <div class="line"><div class="bar" id="confBar"></div></div>
    </div>
    <div style="margin-top:10px">
      <span id="playSignal" class="pill">—</span>
      <span id="top2" class="pill">Safe set: —</span>
      <span id="top3" class="pill">Top-3: —</span>
      <span id="reasons" class="pill">—</span>
    </div>
  </div>

  <div class="grid2" style="margin-top:14px">
    <div class="card">
      <div class="section-title">📊 Probability (0–9)</div>
      <canvas id="probChart" height="220"></canvas>
    </div>
    <div class="card">
      <div class="section-title">🕘 Recent Predictions</div>
      <div id="hist" class="history">—</div>
    </div>
  </div>
</div>

<script>
/* ===== Notifications (same as before) ===== */
(async function setupSW(){
  if('serviceWorker' in navigator){
    try{ await navigator.serviceWorker.register('/sw.js',{scope:'/'}); await navigator.serviceWorker.ready; }catch{}
  }
})();
async function ensureNotifyPerm(){
  if(!('Notification' in window)) return false;
  if(Notification.permission==='granted') return true;
  if(Notification.permission==='denied') return false;
  try{ return (await Notification.requestPermission())==='granted'; }catch{ return false; }
}
async function notifyViaSW({tail,digit,size}){
  try{
    const reg = await navigator.serviceWorker.ready; if(!reg) return;
    const ok = await ensureNotifyPerm(); if(!ok) return;
    await reg.showNotification(`Next • ${tail}`,{
      body:`#${digit} • ${size}`, tag:`wingo-${tail}`, renotify:true, requireInteraction:true,
      icon:'/icons/icon-192.png', badge:'/icons/icon-192.png', vibrate:[80,30,80]
    });
  }catch{}
}

/* ===== Helpers ===== */
const el=id=>document.getElementById(id);
const isDigits=s=>/^\d+$/.test(s||""); const clamp01=x=>Math.max(0,Math.min(1,x));
const normalize=a=>{const s=a.reduce((p,c)=>p+c,0)||1;return a.map(x=>x/s);};
const argmax=a=>a.indexOf(Math.max(...a));
const bump=p=>{try{return (BigInt(p)+1n).toString()}catch{const a=p.split('').map(n=>+n);for(let i=a.length-1;i>=0;i--){if(a[i]===9)a[i]=0;else{a[i]++;break;}}return a.join('')}};
function describePeriod(p){return isDigits(p)?`len ${p.length} • tail ${p.slice(-4)}`:'—';}
function hash32(str){let h=2166136261>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0;}
function mulberry32(seed){return function(){let t=seed+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}

/* ===== Priors (debiased) ===== */
function priorPeriodDigits(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const d=[...period].map(Number);
  const s=d.reduce((a,b)=>a+b,0), mod10=s%10, mod7=s%7;
  const freq=Array(10).fill(0); d.forEach(x=>freq[x]++);
  const v=Array(10).fill(0.1);
  v[mod10]+=0.44; v[(mod7*3)%10]+=0.22; v[(mod7*5)%10]+=0.20;
  const mx=Math.max(...freq), mn=Math.min(...freq);
  for(let i=0;i<10;i++){const r=(mx-mn)?(mx-freq[i])/(mx-mn):0; v[i]+=0.06*r}
  return normalize(v);
}
function priorParity(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const even=(+period.slice(-2))%2===0; const v=Array(10).fill(0.1);
  if(even){for(let i=0;i<10;i+=2)v[i]+=0.22}else{for(let i=1;i<10;i+=2)v[i]+=0.22}
  return normalize(v);
}
function priorBucket(period, antiSeq){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const tail=+period.slice(-3), m=tail%10, v=Array(10).fill(0.1);
  const k=antiSeq?0.16:0.36; v[m]+=k; v[(m+3)%10]+=k*0.55; v[(m+7)%10]+=k*0.45;
  return normalize(v);
}
function priorChecksum(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const s=[...period].reduce((a,b)=>a+(+b),0), t=(s%9+s%10)%10;
  const v=Array(10).fill(0.1); v[t]+=0.30; v[(t+1)%10]+=0.16; v[(t+9)%10]+=0.16; return normalize(v);
}
function priorDistanceHashed(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const seedDigit = hash32(period+'d')%10;
  const v=Array(10).fill(0.1);
  for(let i=0;i<10;i++){const d=Math.min((i-seedDigit+10)%10,(seedDigit-i+10)%10); v[i]+=0.28*Math.exp(-0.55*d);}
  return normalize(v);
}

/* ===== Size learning ===== */
const LS_SIZE='WPP_SIZE2';
const loadSize =()=>{try{return JSON.parse(localStorage.getItem(LS_SIZE))||[1,1]}catch{return [1,1]}};
const saveSize =s=>localStorage.setItem(LS_SIZE,JSON.stringify(s));
function regimeWeights(w){
  const s=loadSize(); const big=s[1]/(s[0]+s[1]); const out=w.slice();
  if(big>0.62||big<0.38) out[4]+=0.02;
  const sum=out.reduce((a,b)=>a+b,0); return out.map(x=>x/sum);
}

/* ===== Predictor (with BEAST) ===== */
function predictLocal(period, mode, antiSeq, learnOn){
  const cfg={
    conservative:{temp:1.04,cap:0.58,jitter:0.05,adapt:0.12,w:[0.34,0.16,0.18,0.18,0.14],learnBoost:0.25},
    balanced    :{temp:1.06,cap:0.62,jitter:0.08,adapt:0.18,w:[0.32,0.18,0.20,0.18,0.12],learnBoost:0.30},
    aggressive  :{temp:1.08,cap:0.66,jitter:0.12,adapt:0.24,w:[0.30,0.18,0.22,0.18,0.12],learnBoost:0.35},
    beast       :{temp:1.02,cap:0.55,jitter:0.04,adapt:0.26,w:[0.36,0.18,0.22,0.16,0.08],learnBoost:0.40}
  }[mode]||{temp:1.06,cap:0.62,jitter:0.08,adapt:0.18,w:[0.32,0.18,0.20,0.18,0.12],learnBoost:0.30};

  const P1=priorPeriodDigits(period), P2=priorParity(period), P3=priorBucket(period,antiSeq), P4=priorChecksum(period), P5=priorDistanceHashed(period);
  const w=regimeWeights(cfg.w);
  let base=normalize(P1.map((_,i)=> w[0]*P1[i]+w[1]*P2[i]+w[2]*P3[i]+w[3]*P4[i]+w[4]*P5[i]));

  const sorted=base.slice().sort((a,b)=>b-a), t=sorted[2]||0.1;
  base=normalize(base.map(p=>p*(1+cfg.adapt*((p-t)/(t+1e-9)))));

  if(learnOn){
    const sz=loadSize(); const total=(sz[0]+sz[1])||1;
    const smallBias=sz[0]/total, bigBias=sz[1]/total, k=cfg.learnBoost;
    for(let i=0;i<5;i++)  base[i]*=(1 - k + k*smallBias);
    for(let i=5;i<10;i++) base[i]*=(1 - k + k*bigBias);
    base=normalize(base);
  }

  const seed=hash32(period); const rnd=mulberry32(seed);
  const B=84,j=cfg.jitter; const agg=Array(10).fill(0), votes=Array(10).fill(0);
  for(let b=0;b<B;b++){ const p=normalize(base.map(x=>Math.max(0,x*(1+(rnd()*2-1)*j)))); p.forEach((x,i)=>agg[i]+=x); votes[argmax(p)]++; }
  let probs=normalize(agg).map(p=>Math.pow(p,1/cfg.temp)); probs=normalize(probs);
  const iM=argmax(probs), mx=probs[iM];
  if(mx>cfg.cap){ const excess=mx-cfg.cap; probs[iM]-=excess; const rest=probs.reduce((a,b,i)=>i===iM?a:a+b,0)||1; const scale=(1-probs[iM])/rest; for(let i=0;i<10;i++) if(i!==iM) probs[i]*=scale; probs=normalize(probs); }
  const stability=Math.max(...votes)/B;
  return {probs,stability};
}

/* ===== Chart ===== */
let probChart=null;
function renderCharts(probs){
  const data=probs.map(p=>Math.round(p*1000)/10);
  const labels=[...Array(10).keys()].map(String);
  if(probChart) probChart.destroy();
  probChart=new Chart(el('probChart').getContext('2d'),{
    type:'bar', data:{labels,datasets:[{label:'Probability (%)',data}]},
    options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'%'}},x:{title:{display:true,text:'Digit'}}}}
  });
}

/* ===== Render ===== */
function renderResult(period, out, source='manual'){
  const probs=out.probs.slice(); const pick=argmax(probs);
  renderCharts(probs);

  let H=0; probs.forEach(p=>{ if(p>0) H+=-p*Math.log(p) }); const entropy=clamp01(1-H/Math.log(10));
  const stability=clamp01(out.stability||0); const score=clamp01(0.55*entropy+0.45*stability);

  el('resultCard').style.display='block';
  el('vPeriod').textContent=period;
  el('vNum').textContent=pick;
  el('vSize').textContent=pick>=5?'Big':'Small';
  el('confBar').style.width=(score*100).toFixed(1)+'%';
  el('hiAcc').style.display=score>=0.85?'inline-flex':'none';

  const issues=[]; if(entropy<0.18) issues.push('low entropy'); if(stability<0.28) issues.push('unstable');
  let signal='Play',cls='ok'; if(issues.length===1){signal='Caution';cls='warn'} if(issues.length>=2){signal='Wait';cls='bad'}
  el('playSignal').textContent=signal; el('playSignal').className='pill '+cls;

  const sorted=probs.map((p,i)=>({i,p})).sort((a,b)=>b.p-a.p);
  el('top2').textContent='Safe set: '+sorted.slice(0,2).map(o=>o.i).join(', ');
  el('top3').textContent='Top-3: '+sorted.slice(0,3).map(o=>`${o.i} (${(o.p*100).toFixed(1)}%)`).join(', ');
  el('reasons').textContent=`Score ${(score*100).toFixed(0)}%`;

  const h=el('hist'); if(h.textContent==='—') h.textContent='';
  h.insertAdjacentHTML('afterbegin',`<div class="hrow">⏱ ${new Date().toLocaleTimeString()} • tail ${String(period).slice(-4)} → #${pick} (${pick>=5?'Big':'Small'})</div>`);
  [...h.children].slice(14).forEach(n=>n.remove());

  if(source==='auto' && el('autoNext').checked){
    notifyViaSW({tail:String(period).slice(-3), digit:pick, size:(pick>=5?'Big':'Small')});
  }
}

/* ===== Actions ===== */
let autoTimer=null, busy=false;
async function runPredict(source='manual'){
  try{
    if(busy) return; busy=true; setTimeout(()=>busy=false,120);
    const pr=el('period').value.trim(); if(!isDigits(pr)){alert('Valid period number भरें');return;}
    el('periodInfo').textContent='Period: '+describePeriod(pr);
    const out=predictLocal(pr, el('mode').value, el('antiSeq').checked, el('learnOn').checked);
    renderResult(pr,out,source);
  }catch(err){
    console.warn('Predict failed', err);
    alert('Predict में कोई error आया. कृपया फिर से ट्राई करें.');
  }
}
function startAuto(){
  const sec=Math.max(5, parseInt(el('autoEvery').value||'30',10));
  clearInterval(autoTimer);
  autoTimer=setInterval(()=>{
    const cur=el('period').value.trim(); if(isDigits(cur)) el('period').value=bump(cur);
    runPredict('auto');
  }, sec*1000);
}

/* ===== Bindings ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('btnPredict').addEventListener('click', ()=>runPredict('manual'));
  document.getElementById('period').addEventListener('keydown', e=>{ if(e.key==='Enter') runPredict('manual'); });
  document.getElementById('btnClear').addEventListener('click', ()=>{
    clearInterval(autoTimer); autoTimer=null; document.getElementById('autoNext').checked=false;
    document.getElementById('period').value=''; document.getElementById('periodInfo').textContent='—';
    document.getElementById('resultCard').style.display='none'; document.getElementById('hist').textContent='—';
    if(probChart){probChart.destroy();probChart=null}
  });
  document.getElementById('btnCopy').addEventListener('click', async ()=>{
    const txt=`Period: ${el('vPeriod').textContent}, Number: ${el('vNum').textContent}, Size: ${el('vSize').textContent}`;
    try{ await navigator.clipboard.writeText(txt); alert('Copied!'); }catch{}
  });
  document.getElementById('autoNext').addEventListener('change', async e=>{
    clearInterval(autoTimer); autoTimer=null;
    if(e.target.checked){ await ensureNotifyPerm(); startAuto(); }
  });
  document.getElementById('notifyBtn').addEventListener('click', async ()=> alert((await ensureNotifyPerm())?'Notifications enabled':'Notifications blocked'));

  // Verify & Learn — colored WIN/LOSS
  document.getElementById('btnVerify').addEventListener('click', ()=>{
    const pick = el('vNum').textContent.trim();
    const msg = el('verifyMsg');
    if(!pick || pick==='—'){ msg.textContent='पहले Predict करें.'; msg.style.color='#9ca3af'; return; }
    const chosen = document.querySelector('input[name="actSize"]:checked');
    if(!chosen){ msg.textContent='Actual के लिए Big/Small चुनें.'; msg.style.color='#9ca3af'; return; }

    const actualSize = chosen.value;                    // 'small' | 'big'
    const predictedSize = (+pick>=5)?'big':'small';
    const win = (actualSize===predictedSize);

    if(win){ msg.textContent='WIN ✔'; msg.style.color='var(--ok)'; }
    else   { msg.textContent=`LOSS ✘ (picked ${predictedSize.toUpperCase()})`; msg.style.color='var(--bad)'; }

    if(document.getElementById('learnOn').checked){
      const s=loadSize(); if(actualSize==='small') s[0]++; else s[1]++; saveSize(s);
    }
  });
});
</script>
</body>
</html>
