<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üéØ WinGo Predictor Pro ‚Äî Period Only</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --gold:#FFD700;--gold-2:#f5d46b;--bg1:#0b0b0b;--bg2:#000;--card:#121212;
  --ok:#22c55e;--warn:#f59e0b;--bad:#f87171;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35)
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto;background:linear-gradient(140deg,var(--bg1),var(--bg2));color:#fff}
header{position:sticky;top:0;z-index:5;background:#000;border-bottom:1px solid #111;padding:14px 16px}
.brand{max-width:1180px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:22px;color:#FFD700}
.container{max-width:1180px;margin:0 auto;padding:22px 16px 40px}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
.btn{background:linear-gradient(180deg,var(--gold),var(--gold-2));color:#000;font-weight:800;border:0;padding:12px 18px;border-radius:12px;cursor:pointer}
.btn.secondary{background:#1f2937;color:#e5e7eb;border:1px solid #2b3442}
.meta{color:#9ca3af;font-size:13px;margin-top:6px}
.kv{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.kv .box{background:#0a0a0a;border:1px solid #222;border-radius:14px;padding:16px}
.key{color:#9ca3af;font-size:13px}.val{font-weight:900;font-size:32px;color:var(--gold)}
.line{height:10px;background:#1f2937;border-radius:999px;overflow:hidden;margin:8px 0 2px}
.bar{height:10px;width:0%;background:linear-gradient(90deg,var(--gold-2),var(--gold))}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #2b3442;margin-right:6px;font-weight:700}
.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.grid2{display:grid;grid-template-columns:1.6fr 1fr;gap:16px}
@media(max-width:900px){.grid2{grid-template-columns:1fr}.kv{grid-template-columns:1fr}}
.history{font-size:12px;color:#cbd5e1;max-height:220px;overflow:auto}.hrow{padding:6px 0;border-bottom:1px dashed #222}
.small{font-size:12px;color:#cbd5e1}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.switch{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:#cbd5e1}
.badge{display:inline-block;padding:4px 8px;border-radius:8px;font-size:12px;background:#1a1a1a;border:1px solid #2a2a2a;margin-left:8px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <span>üéØ WinGo Predictor Pro</span>
    <label class="switch">
      <input type="checkbox" id="compactToggle"> Compact View
    </label>
  </div>
</header>

<div class="container" id="appRoot">
  <div class="card">
    <div class="grid2">
      <div>
        <label for="period">üßæ Period Number (required)</label>
        <input id="period" placeholder="e.g. 20250813100052810"/>
        <div class="meta">bdgop WinGo_30S ‡§ú‡•à‡§∏‡§æ ‡§≤‡§Æ‡•ç‡§¨‡§æ period ID ‚Äî ‡§ï‡•á‡§µ‡§≤ digits (0‚Äì9)</div>
      </div>
      <div>
        <label for="mode">Strategy</label>
        <select id="mode">
          <option value="balanced" selected>Normal</option>
          <option value="conservative">Confidence</option>
          <option value="aggressive">Very Confident</option>
        </select>
        <div class="row meta" style="margin-top:10px">
          <span>
            <input id="autoNext" type="checkbox" style="transform:translateY(2px)"> Auto Next
            <input id="autoEvery" type="number" min="5" value="30" style="width:90px;margin-left:8px"> sec
          </span>
          <label class="switch"><input type="checkbox" id="antiSeq" checked> Anti-sequence</label>
          <label class="switch"><input type="checkbox" id="learnOn" checked> Learning ON</label>
          <button class="btn secondary" id="resetLearnBtn" title="Clear learned calibration">Reset Learning</button>
          <button class="btn secondary" id="notifyBtn">üîî Notifications</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <button class="btn" id="btnPredict">üîÆ Predict</button>
      <button class="btn secondary" id="btnClear">Clear</button>
      <button class="btn secondary" id="btnCopy">Copy Result</button>
      <span class="meta" id="periodInfo">‚Äî</span>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1;min-width:240px">
        <label for="actual">‚úÖ Actual result (0‚Äì9) ‚Äî optional (learning)</label>
        <input id="actual" placeholder="e.g. 7"/>
      </div>
      <button class="btn secondary" id="btnVerify">Verify & Learn</button>
      <span class="meta" id="verifyMsg">‚Äî</span>
    </div>
  </div>

  <div class="card" id="resultCard" style="margin-top:16px;display:none">
    <div class="kv">
      <div class="box"><div class="key">üßæ Period</div><div class="val" id="vPeriod">‚Äî</div></div>
      <div class="box"><div class="key">üî¢ Predicted Number</div><div class="val" id="vNum">‚Äî</div></div>
      <div class="box"><div class="key">üìè Size</div><div class="val" id="vSize">‚Äî</div></div>
    </div>

    <div style="margin-top:12px">
      <div class="key">üß† Confidence <span class="badge" id="hiAcc" style="display:none">üî• High Accuracy</span></div>
      <div class="line"><div class="bar" id="confBar"></div></div>
    </div>

    <div style="margin-top:12px">
      <span id="playSignal" class="pill">‚Äî</span>
      <span id="top2" class="pill">Safe set: ‚Äî</span>
      <span id="top3" class="pill">Top-3: ‚Äî</span>
      <span id="reasons" class="pill">‚Äî</span>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">üïò Recent Predictions</h3>
    <div id="hist" class="history">‚Äî</div>
  </div>
</div>

<script>
/* ====== (Optional) Service Worker register for OS notifications ====== */
(async function setupSW(){
  if('serviceWorker' in navigator){
    try{ await navigator.serviceWorker.register('/sw.js',{scope:'/'}); await navigator.serviceWorker.ready; }catch{}
  }
})();
async function ensureNotifyPerm(){
  if(!('Notification' in window)) return false;
  if(Notification.permission==='granted') return true;
  if(Notification.permission==='denied') return false;
  try{ return (await Notification.requestPermission())==='granted'; }catch{ return false; }
}
async function notifyViaSW({tail,digit,size}){
  try{
    const reg = await navigator.serviceWorker.ready;
    if(!reg) return;
    const ok = await ensureNotifyPerm(); if(!ok) return;
    await reg.showNotification(`Next ‚Ä¢ ${tail}`,{
      body:`#${digit} ‚Ä¢ ${size}`,
      tag:`wingo-${tail}`, renotify:true, requireInteraction:true,
      icon:'/icons/icon-192.png', badge:'/icons/icon-192.png', vibrate:[80,30,80]
    });
  }catch{}
}

/* ====== Utilities ====== */
const el=id=>document.getElementById(id);
const isDigits=s=>/^\d+$/.test(s||"");
const clamp01=x=>Math.max(0,Math.min(1,x));
const normalize=a=>{const s=a.reduce((p,c)=>p+c,0)||1;return a.map(x=>x/s);};
const argmax=a=>a.indexOf(Math.max(...a));
const fmtPct=x=>(x*100).toFixed(1)+'%';
const bump = p => { try{return (BigInt(p)+1n).toString()}catch{ const a=p.split('').map(n=>+n); for(let i=a.length-1;i>=0;i--){ if(a[i]===9)a[i]=0; else{a[i]++;break;} } return a.join(''); } };

/* ====== Learning store (Dirichlet) ====== */
const LS_ALPHA='WPP_ALPHA10', LS_SIZE='WPP_SIZE2', LS_RECENT='WPP_RECENT20';
function loadAlpha(){ try{ return JSON.parse(localStorage.getItem(LS_ALPHA)) || Array(10).fill(1); }catch{ return Array(10).fill(1); } }
function saveAlpha(a){ localStorage.setItem(LS_ALPHA, JSON.stringify(a)); }
function loadSize(){ try{ return JSON.parse(localStorage.getItem(LS_SIZE)) || [1,1]; }catch{ return [1,1]; } } // [small0-4, big5-9]
function saveSize(s){ localStorage.setItem(LS_SIZE, JSON.stringify(s)); }
function pushRecent(digit){
  try{
    const r = JSON.parse(localStorage.getItem(LS_RECENT)) || [];
    r.unshift(digit); if(r.length>20) r.length=20;
    localStorage.setItem(LS_RECENT, JSON.stringify(r));
  }catch{}
}
function readRecent(){ try{ return JSON.parse(localStorage.getItem(LS_RECENT)) || []; }catch{ return []; } }
function resetLearning(){
  saveAlpha(Array(10).fill(1));
  saveSize([1,1]);
  localStorage.removeItem(LS_RECENT);
}

/* ====== Seeded RNG ====== */
function hash32(str){let h=2166136261>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0;}
function mulberry32(seed){return function(){let t=seed+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}

/* ====== Priors (5 signals) ====== */
function priorPeriodDigits(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const d=[...period].map(Number);
  const s=d.reduce((a,b)=>a+b,0), last=d[d.length-1], last2=+period.slice(-2), mod10=s%10, mod7=s%7;
  const freq=Array(10).fill(0); d.forEach(x=>freq[x]++);
  const v=Array(10).fill(0.1);
  v[mod10]+=0.6;
  v[(last+10)%10]+=0.28; v[(last+1)%10]+=0.14; v[(last+9)%10]+=0.14;
  v[(mod7*3)%10]+=0.20; v[(mod7*5)%10]+=0.18;
  if(last2%2===0){ for(let i=0;i<10;i+=2) v[i]+=0.08 } else { for(let i=1;i<10;i+=2) v[i]+=0.08 }
  const mx=Math.max(...freq), mn=Math.min(...freq);
  for(let i=0;i<10;i++){ const r=(mx-mn)?(mx-freq[i])/(mx-mn):0; v[i]+=0.05*r }
  return normalize(v);
}
function priorParity(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const even=(+period.slice(-2))%2===0; const v=Array(10).fill(0.1);
  if(even){ for(let i=0;i<10;i+=2) v[i]+=0.22 } else { for(let i=1;i<10;i+=2) v[i]+=0.22 }
  return normalize(v);
}
function priorBucket(period, antiSeq){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const tail=+period.slice(-3), m=tail%10, v=Array(10).fill(0.1);
  const k=antiSeq?0.18:0.42; v[m]+=k; v[(m+3)%10]+=k*0.5; v[(m+7)%10]+=k*0.4;
  return normalize(v);
}
function priorChecksum(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const s=[...period].reduce((a,b)=>a+(+b),0), t=(s%9+s%10)%10;
  const v=Array(10).fill(0.1); v[t]+=0.32; v[(t+1)%10]+=0.17; v[(t+9)%10]+=0.17; return normalize(v);
}
function priorDistance(period){
  if(!isDigits(period)) return Array(10).fill(0.1);
  const last=+period.slice(-1); const v=Array(10).fill(0.1);
  for(let i=0;i<10;i++){ const d=Math.min((i-last+10)%10,(last-i+10)%10); v[i]+=0.30*Math.exp(-0.55*d); }
  return normalize(v);
}

/* ====== Regime detector (recent verified 20) ====== */
function regimeWeights(baseW){
  const r = readRecent();
  if(!r.length) return baseW;
  const odd = r.filter(x=>x%2===1).length / r.length;
  const big = r.filter(x=>x>=5).length / r.length;
  // small, subtle tilt
  const w = baseW.slice();
  if(odd>0.62) { w[1]+=0.02; } // parity prior weight+
  if(odd<0.38) { w[1]+=0.02; }
  if(big>0.62) { w[4]+=0.02; } // distance prior (big side) tilt
  if(big<0.38) { w[4]+=0.02; }
  const s=w.reduce((a,b)=>a+b,0); return w.map(x=>x/s);
}

/* ====== Predictor (Ensemble + Learning Calibration) ====== */
function predictLocal(period, mode, antiSeq, learnOn){
  const hyper={
    conservative:{temp:1.04,cap:0.58,jitter:0.05,adapt:0.12,w:[0.36,0.14,0.16,0.18,0.16]},
    balanced    :{temp:1.06,cap:0.62,jitter:0.08,adapt:0.18,w:[0.34,0.16,0.18,0.18,0.14]},
    aggressive  :{temp:1.08,cap:0.66,jitter:0.12,adapt:0.24,w:[0.32,0.16,0.20,0.18,0.14]}
  }[mode]||{temp:1.06,cap:0.62,jitter:0.08,adapt:0.18,w:[0.34,0.16,0.18,0.18,0.14]};

  // priors
  const P1=priorPeriodDigits(period);
  const P2=priorParity(period);
  const P3=priorBucket(period,antiSeq);
  const P4=priorChecksum(period);
  const P5=priorDistance(period);

  // regime-aware weights
  const w = regimeWeights(hyper.w);

  // base blend
  let base = normalize(P1.map((_,i)=> w[0]*P1[i]+w[1]*P2[i]+w[2]*P3[i]+w[3]*P4[i]+w[4]*P5[i]));

  // adaptive push (3rd best pivot)
  const sorted=base.slice().sort((a,b)=>b-a), t=sorted[2]||0.1;
  base = normalize(base.map(p=>p*(1+hyper.adapt*((p-t)/(t+1e-9)))));

  // === Online learning calibration ===
  if(learnOn){
    const alpha = loadAlpha();                 // Dirichlet counts (10)
    const size  = loadSize();                 // [small, big]
    // Posterior: multiply base with alpha
    base = normalize(base.map((p,i)=> p * (alpha[i]||1)));
    // Size prior push from learned frequency
    const smallWeight = (size[0]||1), bigWeight=(size[1]||1);
    const smallScale = smallWeight/(smallWeight+bigWeight);
    const bigScale   = bigWeight/(smallWeight+bigWeight);
    for(let i=0;i<5;i++)  base[i] *= (0.9 + 0.2*smallScale);
    for(let i=5;i<10;i++) base[i] *= (0.9 + 0.2*bigScale);
    base = normalize(base);
  }

  // bootstrap (seeded for stability)
  const seed=hash32(period); const rnd=mulberry32(seed);
  const B=72,j=hyper.jitter; const agg=Array(10).fill(0); const votes=Array(10).fill(0);
  for(let b=0;b<B;b++){
    const p=normalize(base.map(x=>Math.max(0,x*(1+(rnd()*2-1)*j))));
    p.forEach((x,i)=>agg[i]+=x); votes[argmax(p)]++;
  }
  let probs=normalize(agg).map(p=>Math.pow(p,1/hyper.temp)); probs=normalize(probs);

  const iM=argmax(probs), mx=probs[iM];
  if(mx>hyper.cap){
    const excess=mx-hyper.cap; probs[iM]-=excess;
    const rest=probs.reduce((a,b,i)=>i===iM?a:a+b,0)||1;
    const scale=(1-probs[iM])/rest; for(let i=0;i<10;i++) if(i!==iM) probs[i]*=scale; probs=normalize(probs);
  }
  const stability=Math.max(...votes)/B;
  return {probs, stability, source:'local'};
}

/* ====== Charts (simple) ====== */
let probChart=null, bsChart=null;
function renderCharts(probs){
  const big=probs.slice(5).reduce((a,b)=>a+b,0), small=1-big;
  const labels=[...Array(10).keys()].map(String);
  const data=probs.map(p=>Math.round(p*1000)/10);
  if(probChart) probChart.destroy();
  probChart=new Chart(el('probChart')?.getContext?.('2d')||document.createElement('canvas'),{
    type:'bar', data:{labels,datasets:[{label:'Probability (%)',data}]},
    options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'%'}},x:{title:{display:true,text:'Digit'}}}}
  });
  if(bsChart) bsChart.destroy();
  bsChart=new Chart(el('bsChart')?.getContext?.('2d')||document.createElement('canvas'),{
    type:'doughnut', data:{labels:['Big','Small'],datasets:[{data:[Math.round(big*100),Math.round(small*100)]}]},
    options:{responsive:true,cutout:'60%'}
  });
  return {big,small};
}

/* ====== Render ====== */
function renderResult(period, payload, source='manual'){
  const probs=payload.probs.slice(); const predicted=argmax(probs);
  const {big,small}=renderCharts(probs);
  let H=0; probs.forEach(p=>{ if(p>0) H+=-p*Math.log(p) }); const entropy=clamp01(1-H/Math.log(10));
  const stability=clamp01(payload.stability||0); const score=clamp01(0.55*entropy+0.45*stability);

  el('resultCard').style.display='block';
  el('vPeriod').textContent=period;
  el('vNum').textContent=predicted;
  el('vSize').textContent=predicted>=5?'Big':'Small';
  el('confBar').style.width=(score*100).toFixed(1)+'%';
  el('hiAcc').style.display=score>=0.85?'inline-block':'none';

  const issues=[]; if(entropy<0.18) issues.push('low entropy'); if(stability<0.28) issues.push('unstable');
  let signal='Play',cls='ok'; if(issues.length===1){signal='Caution';cls='warn'} if(issues.length>=2){signal='Wait';cls='bad'}
  el('playSignal').textContent=signal; el('playSignal').className='pill '+cls;
  const sorted=probs.map((p,i)=>({i,p})).sort((a,b)=>b.p-a.p);
  el('top2').textContent='Safe set: '+sorted.slice(0,2).map(o=>o.i).join(', ');
  el('top3').textContent='Top-3: '+sorted.slice(0,3).map(o=>`${o.i} (${(o.p*100).toFixed(1)}%)`).join(', ');
  el('reasons').textContent = issues.length ? ('Reasons: '+issues.join(', ')) : `Score: ${(score*100).toFixed(0)}%`;

  const h=el('hist'); if(h.textContent==='‚Äî') h.textContent='';
  h.insertAdjacentHTML('afterbegin',`<div class="hrow">‚è± ${new Date().toLocaleTimeString()} ‚Ä¢ ${period.slice(-6)} ‚Üí #${predicted} (${predicted>=5?'Big':'Small'}) ‚Ä¢ score ${(score*100).toFixed(0)}%</div>`);
  [...h.children].slice(12).forEach(n=>n.remove());

  // Background OS notification (when auto mode)
  if(source==='auto' && el('autoNext').checked){
    notifyViaSW({tail:String(period).slice(-3), digit:predicted, size:(predicted>=5?'Big':'Small')});
  }
}

/* ====== Actions ====== */
let autoTimer=null, clickBusy=false;
function describePeriod(p){ return isDigits(p) ? `len ${p.length} ‚Ä¢ tail ${p.slice(-4)}` : '‚Äî'; }

async function runPredict(source='manual'){
  if(clickBusy) return; clickBusy=true; setTimeout(()=>clickBusy=false,150);
  const pr=el('period').value.trim(); if(!isDigits(pr)){ alert('Valid period number ‡§≠‡§∞‡•á‡§Ç (‡§ï‡•á‡§µ‡§≤ digits)'); return; }
  el('periodInfo').textContent = 'Period: '+describePeriod(pr);
  const out = predictLocal(pr, el('mode').value, el('antiSeq').checked, el('learnOn').checked);
  renderResult(pr,out,source);
}

function startAuto(){
  const sec=Math.max(5, parseInt(el('autoEvery').value||'30',10));
  clearInterval(autoTimer);
  autoTimer=setInterval(()=>{
    const cur=el('period').value.trim();
    if(isDigits(cur)) el('period').value=bump(cur);
    runPredict('auto');
  }, sec*1000);
}

/* ====== Event binds ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  el('btnPredict').addEventListener('click', ()=>runPredict('manual'));
  el('period').addEventListener('keydown', e=>{ if(e.key==='Enter') runPredict('manual'); });
  el('btnClear').addEventListener('click', ()=>{
    clearInterval(autoTimer); autoTimer=null; el('autoNext').checked=false;
    el('period').value=''; el('periodInfo').textContent='‚Äî'; el('resultCard').style.display='none'; el('hist').textContent='‚Äî';
    if(probChart){ probChart.destroy(); probChart=null } if(bsChart){ bsChart.destroy(); bsChart=null }
  });
  el('btnCopy').addEventListener('click', async ()=>{
    const txt=`Period: ${el('vPeriod').textContent}, Number: ${el('vNum').textContent}, Size: ${el('vSize').textContent}`;
    try{ await navigator.clipboard.writeText(txt); alert('Copied!'); }catch{}
  });
  el('autoNext').addEventListener('change', async e=>{
    clearInterval(autoTimer); autoTimer=null;
    if(e.target.checked){ await ensureNotifyPerm(); startAuto(); }
  });
  el('notifyBtn').addEventListener('click', async ()=>{
    alert((await ensureNotifyPerm()) ? 'Notifications enabled' : 'Notifications blocked');
  });
  el('resetLearnBtn').addEventListener('click', ()=>{
    if(confirm('Reset learning (digit & size calibration)?')){ resetLearning(); alert('Learning data cleared.'); }
  });

  // Verify = update learning
  el('btnVerify').addEventListener('click', ()=>{
    const act = el('actual').value.trim();
    if(!/^[0-9]$/.test(act)){ el('verifyMsg').textContent='‡§è‡§ï ‡§Ö‡§Ç‡§ï 0‚Äì9 ‡§≠‡§∞‡•á‡§Ç.'; return; }
    const pick = el('vNum').textContent.trim();
    if(!pick || pick==='‚Äî'){ el('verifyMsg').textContent='‡§™‡§π‡§≤‡•á Predict ‡§ï‡§∞‡•á‡§Ç.'; return; }
    const win = (+act === +pick);
    el('verifyMsg').textContent = win ? `WIN ‚úî ‚Ä¢ picked ${pick} ‚Ä¢ actual ${act}` : `LOSS ‚úò ‚Ä¢ picked ${pick} ‚Ä¢ actual ${act}`;

    // learning update (Dirichlet + size counts + regime)
    if(el('learnOn').checked){
      const a = loadAlpha(); a[+act] = (a[+act]||1) + 1; saveAlpha(a);
      const s = loadSize(); (+act>=5) ? s[1]++ : s[0]++; saveSize(s);
      pushRecent(+act);
    }
  });
});
</script>

<!-- Hidden canvases for charts (optional; create if you want visible) -->
<canvas id="probChart" style="display:none"></canvas>
<canvas id="bsChart"   style="display:none"></canvas>
</body>
</html>
