<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üéØ WinGo Predictor Pro ‚Äî Period Only</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --gold:#FFD700; --gold-2:#f5d46b; --ink:#e5e7eb; --bg1:#0b0b0b; --bg2:#000;
           --card:#121212; --ok:#22c55e; --warn:#f59e0b; --bad:#f87171; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto; background:linear-gradient(140deg,var(--bg1),var(--bg2)); color:#fff; }
    header{ position:sticky; top:0; z-index:5; background:#000; border-bottom:1px solid #111; padding:14px 16px; box-shadow:0 2px 12px rgba(0,0,0,.35); }
    .brand{ max-width:1180px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:800; font-size:22px; color:var(--gold); }
    .container{ max-width:1180px; margin:0 auto; padding:22px 16px 40px }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow) }
    .grid2{ display:grid; grid-template-columns:1.6fr 1fr; gap:16px } @media (max-width:900px){ .grid2{ grid-template-columns:1fr } }
    label{ font-size:14px; font-weight:700; color:#e7e7e7; display:block; margin-bottom:8px }
    input,select{ width:100%; padding:14px; border-radius:12px; border:2px solid #333; background:#0b0b0b; color:#fff; font-size:16px; outline:none }
    input:focus,select:focus{ border-color:var(--gold) }
    .meta{ color:#9ca3af; font-size:13px; margin-top:6px }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px }
    .btn{ background:linear-gradient(180deg,var(--gold),var(--gold-2)); color:#000; font-weight:800; border:0; padding:12px 18px; border-radius:12px; cursor:pointer; box-shadow:0 0 0 2px rgba(0,0,0,.2), 0 10px 18px rgba(255,215,0,.15) }
    .btn.secondary{ background:#1f2937; color:#e5e7eb; border:1px solid #2b3442; box-shadow:none }
    .tag{ display:inline-block; padding:6px 10px; border:1px solid #2b3442; border-radius:999px; font-size:12px; color:#cbd5e1 }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #2b3442; margin-right:6px; font-weight:700 }
    .ok{ color:var(--ok) } .warn{ color:var(--warn) } .bad{ color:var(--bad) }

    .kv{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px } @media (max-width:900px){ .kv{ grid-template-columns:1fr } }
    .kv .box{ background:#0a0a0a; border:1px solid #222; border-radius:14px; padding:16px }
    .key{ color:#9ca3af; font-size:13px } .val{ font-weight:900; font-size:32px; color:var(--gold) }

    .bigSmallRow{ margin-top:12px; display:grid; grid-template-columns:1.2fr .9fr .9fr; gap:12px }
    .statCard{ background:#0d0f12; border:1px solid #202a36; border-radius:12px; padding:12px }
    .valXL{ font-weight:900; font-size:22px; color:var(--gold) }
    .line{ height:10px; background:#1f2937; border-radius:999px; overflow:hidden; margin:8px 0 2px } .bar{ height:10px; width:0%; background:linear-gradient(90deg,var(--gold-2),var(--gold)) }

    .gridCharts{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px } @media (max-width:900px){ .gridCharts{ grid-template-columns:1fr } }
    .history{ font-size:12px; color:#cbd5e1; max-height:200px; overflow:auto } .hrow{ padding:6px 0; border-bottom:1px dashed #222 }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <span>üéØ WinGo Predictor Pro</span>
    <label style="display:inline-flex;gap:8px;align-items:center;font-size:12px;color:#cbd5e1">
      <input type="checkbox" id="compactToggle"> Compact View
    </label>
  </div>
</header>

<div class="container" id="appRoot">
  <div class="card">
    <div class="grid2">
      <div>
        <label for="period">üßæ Period Number (required)</label>
        <input id="period" placeholder="e.g. 20250813100052810" />
        <div class="meta">bdgop WinGo_30S ‡§ú‡•à‡§∏‡§æ ‡§≤‡§Æ‡•ç‡§¨‡§æ period ID ‚Äî ‡§ï‡•á‡§µ‡§≤ digits (0‚Äì9)</div>
      </div>
      <div>
        <label for="mode">Strategy</label>
        <select id="mode">
          <option value="balanced" selected>Normal</option>
          <option value="conservative">Confidence</option>
          <option value="aggressive">Very Confident</option>
        </select>
        <div class="meta" style="margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span>
            <input id="autoNext" type="checkbox" style="transform:translateY(2px)"> Auto Next
            <input id="autoEvery" type="number" min="5" value="30" style="width:90px;margin-left:8px"> sec
          </span>
          <button class="btn secondary" id="notifyBtn">üîî Notifications</button>
          <button class="btn secondary" id="apiBtn" title="Set API base">üîó API</button>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnPredict">üîÆ Predict</button>
      <button class="btn secondary" id="btnClear">Clear</button>
      <button class="btn secondary" id="btnCopy">Copy Result</button>
      <span class="tag" id="apiStatus">Engine: idle</span>
    </div>
    <div class="meta" id="periodInfo">‚Äî</div>
  </div>

  <div class="card" id="resultCard" style="margin-top:16px;display:none">
    <div class="kv">
      <div class="box"><div class="key">üßæ Period</div><div class="val" id="vPeriod">‚Äî</div></div>
      <div class="box"><div class="key">üî¢ Number</div><div class="val" id="vNum">‚Äî</div></div>
      <div class="box"><div class="key">üìè Size</div><div class="val" id="vSize">‚Äî</div></div>
    </div>
    <div class="bigSmallRow">
      <div class="statCard">
        <div class="key">üß† Confidence <span class="tag" id="hiAcc" style="display:none;margin-left:6px">High</span></div>
        <div class="line"><div class="bar" id="confBar"></div></div>
      </div>
      <div class="statCard"><div class="key">üü© Big</div><div class="valXL" id="vBig">‚Äî</div></div>
      <div class="statCard"><div class="key">üü• Small</div><div class="valXL" id="vSmall">‚Äî</div></div>
    </div>
    <div style="margin-top:12px">
      <span id="playSignal" class="pill">‚Äî</span>
      <span id="top2" class="pill">Safe set: ‚Äî</span>
      <span id="top3" class="pill">Top-3: ‚Äî</span>
      <span id="reasons" class="pill">‚Äî</span>
    </div>
  </div>

  <div class="gridCharts" id="chartsWrap">
    <div class="card"><h3 style="margin:0 0 8px">üìä Probability (0‚Äì9)</h3><canvas id="probChart" height="220"></canvas></div>
    <div class="card"><h3 style="margin:0 0 8px">‚öñÔ∏è Big vs Small</h3><canvas id="bsChart" height="220"></canvas></div>
  </div>

  <div class="card" style="margin-top:16px" id="historyWrap">
    <h3 style="margin:0 0 8px">üïò Recent Predictions</h3>
    <div id="hist" class="history">‚Äî</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- utils ----------
  let probChart=null, bsChart=null, autoTimer=null;
  const el=id=>document.getElementById(id);
  const root=document.getElementById('appRoot');
  const clamp01=x=>Math.max(0,Math.min(1,x));
  const fmtPct=x=>(x*100).toFixed(1)+'%';
  const argmax=a=>a.indexOf(Math.max(...a));

  // ---------- API base (auto + override) ----------
  function getApiBase(){
    const url = new URL(location.href);
    const q = url.searchParams.get('api');
    if(q){ localStorage.setItem('WP_API_BASE', q); return q; }
    return localStorage.getItem('WP_API_BASE') || ''; // '' => same origin
  }
  let API_BASE = getApiBase();
  el('apiBtn').addEventListener('click', ()=>{
    const cur = API_BASE || '(same origin)';
    const val = prompt('API base (e.g. https://your-backend.com) ‚Äî blank = same origin', cur==='(same origin)'?'':API_BASE);
    if(val!==null){ API_BASE = val.trim(); localStorage.setItem('WP_API_BASE', API_BASE); alert('Saved.'); }
  });

  // ---------- charts ----------
  function renderCharts(probs){
    const big = probs.slice(5).reduce((a,b)=>a+b,0), small=1-big;
    const labels=[...Array(10).keys()].map(String);
    const data=probs.map(p=>Math.round(p*1000)/10);

    if(probChart) probChart.destroy();
    probChart=new Chart(el('probChart').getContext('2d'),{type:'bar',
      data:{labels,datasets:[{label:'Probability (%)',data}]},
      options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'%'}},x:{title:{display:true,text:'Digit'}}}}
    });
    if(bsChart) bsChart.destroy();
    bsChart=new Chart(el('bsChart').getContext('2d'),{type:'doughnut',
      data:{labels:['Big','Small'],datasets:[{data:[Math.round(big*100),Math.round(small*100)]}]},
      options:{responsive:true,cutout:'60%'}
    });
    return {big,small};
  }

  // ---------- CLIENT-SIDE FALLBACK MODEL ----------
  const normalize=a=>{const s=a.reduce((p,c)=>p+c,0)||1; return a.map(x=>x/s);};
  function priorPeriodDigits(periodStr){
    if(!/^\d+$/.test(periodStr)) return Array(10).fill(0.1);
    const d=[...periodStr].map(Number);
    const s=d.reduce((a,b)=>a+b,0), last=d[d.length-1], last2=+periodStr.slice(-2), mod10=s%10, mod7=s%7;
    const freq=Array(10).fill(0); d.forEach(x=>freq[x]++);
    const v=Array(10).fill(0.1);
    v[mod10]+=0.7; v[(last+10)%10]+=0.35; v[(last+1)%10]+=0.18; v[(last+9)%10]+=0.18;
    v[(mod7*3)%10]+=0.25; v[(mod7*5)%10]+=0.2;
    if(last2%2===0){ for(let i=0;i<10;i+=2) v[i]+=0.08; } else { for(let i=1;i<10;i+=2) v[i]+=0.08; }
    const mx=Math.max(...freq), mn=Math.min(...freq);
    for(let i=0;i<10;i++){ const r=(mx-mn)?(mx-freq[i])/(mx-mn):0; v[i]+=0.06*r; }
    return normalize(v);
  }
  function priorBucket(periodStr){
    if(!/^\d+$/.test(periodStr)) return Array(10).fill(0.1);
    const tail=+periodStr.slice(-3), m=tail%10, v=Array(10).fill(0.1);
    v[m]+=0.5; v[(m+3)%10]+=0.25; v[(m+7)%10]+=0.2; return normalize(v);
  }
  function clientPredict(periodStr, mode){
    const hyper={
      conservative:{temp:1.04, cap:0.58, jitter:0.05, adapt:0.12, w:[0.65,0.35]},
      balanced    :{temp:1.06, cap:0.62, jitter:0.08, adapt:0.18, w:[0.6,0.4]},
      aggressive  :{temp:1.08, cap:0.66, jitter:0.12, adapt:0.24, w:[0.56,0.44]},
    }[mode] || {temp:1.06, cap:0.62, jitter:0.08, adapt:0.18, w:[0.6,0.4]};
    const P1=priorPeriodDigits(periodStr), P2=priorBucket(periodStr);
    let base=normalize(P1.map((_,i)=>hyper.w[0]*P1[i]+hyper.w[1]*P2[i]));
    const sorted=base.slice().sort((a,b)=>b-a), t=sorted[2]||0.1;
    base=normalize(base.map(p=>p*(1+hyper.adapt*((p-t)/(t+1e-9)))));
    const B=64,j=hyper.jitter; const agg=Array(10).fill(0); const votes=Array(10).fill(0);
    for(let b=0;b<B;b++){ const p=normalize(base.map(x=>Math.max(0,x*(1+(Math.random()*2-1)*j)))); p.forEach((x,i)=>agg[i]+=x); votes[argmax(p)]++; }
    let probs=normalize(agg).map(p=>Math.pow(p,1/hyper.temp)); probs=normalize(probs);
    const iM=argmax(probs), mx=probs[iM];
    if(mx>hyper.cap){ const excess=mx-hyper.cap; probs[iM]-=excess; const rest=probs.reduce((a,b,i)=>i===iM?a:a+b,0)||1; const scale=(1-probs[iM])/rest; for(let i=0;i<10;i++) if(i!==iM) probs[i]*=scale; probs=normalize(probs); }
    const stability=Math.max(...votes)/B;
    return {probs, stability, source:'local'};
  }

  // ---------- backend call with graceful fallback ----------
  async function fetchPredict(period, mode){
    const base = API_BASE.replace(/\/+$/,''); // trim slash
    const url = (base?base:'') + '/api/predict?' + new URLSearchParams({period, strategy:mode}).toString();
    try{
      if(!base){ /* same-origin */ }
      const res = await fetch(url, {mode: base? 'cors':'same-origin'});
      if(!res.ok) throw new Error('bad');
      const data = await res.json();
      data.source='server';
      return data;
    }catch(e){
      // fallback to local model
      const fallback = clientPredict(period, mode);
      return {probs:fallback.probs, stability:fallback.stability, source:'local'};
    }
  }

  // ---------- render ----------
  function renderResult(periodStr, payload){
    const probs = payload.probs.slice();
    const predicted = argmax(probs);
    const {big, small} = renderCharts(probs);

    let H=0; probs.forEach(p=>{ if(p>0) H += -p*Math.log(p); });
    const entropyConf = clamp01(1 - H/Math.log(10));
    const stability = clamp01(payload.stability ?? 0);
    const accScore = clamp01(0.55*entropyConf + 0.45*stability);

    const card = document.getElementById('resultCard'); card.style.display='block';
    el('vPeriod').textContent = periodStr;
    el('vNum').textContent = predicted;
    el('vSize').textContent = predicted>=5 ? 'Big' : 'Small';
    el('vBig').textContent = fmtPct(big);
    el('vSmall').textContent = fmtPct(small);
    el('confBar').style.width = (accScore*100).toFixed(1)+'%';
    el('hiAcc').style.display = accScore>=0.85 ? 'inline-block' : 'none';

    const issues=[]; if(entropyConf<0.18) issues.push('low entropy'); if(stability<0.28) issues.push('unstable');
    let signal='Play', cls='ok'; if(issues.length===1){ signal='Caution'; cls='warn'; } if(issues.length>=2){ signal='Wait'; cls='bad'; }
    el('playSignal').textContent=signal; el('playSignal').className='pill '+cls;
    const sorted=probs.map((p,i)=>({i,p})).sort((a,b)=>b.p-a.p);
    el('top2').textContent='Safe set: '+sorted.slice(0,2).map(o=>o.i).join(', ');
    el('top3').textContent='Top-3: '+sorted.slice(0,3).map(o=>`${o.i} (${(o.p*100).toFixed(1)}%)`).join(', ');
    el('reasons').textContent = issues.length ? ('Reasons: '+issues.join(', ')) : `Score: ${(accScore*100).toFixed(0)}%`;

    // history max 10
    const h=el('hist'); if(h.textContent==='‚Äî') h.textContent='';
    h.insertAdjacentHTML('afterbegin', `<div class="hrow">‚è± ${new Date().toLocaleTimeString()} ‚Ä¢ Period ${periodStr} ‚Üí #${predicted} (${predicted>=5?'Big':'Small'}) ‚Ä¢ src ${payload.source} ‚Ä¢ score ${(accScore*100).toFixed(0)}%</div>`);
    [...h.children].slice(10).forEach(n=>n.remove());

    // status chip
    el('apiStatus').textContent = `Engine: ${payload.source==='server'?'server':'local'}`;
    el('apiStatus').style.borderColor = payload.source==='server' ? '#2b8a3e' : '#555';
  }

  // ---------- actions ----------
  async function runPredict(){
    const pr = el('period').value.trim();
    if(!/^\d+$/.test(pr)){ alert('Valid period number ‡§≠‡§∞‡•á‡§Ç (‡§ï‡•á‡§µ‡§≤ digits)'); return; }
    el('periodInfo').textContent = `Period: len ${pr.length} ‚Ä¢ tail ${pr.slice(-4)}`;
    el('apiStatus').textContent = 'Engine: running...';
    const data = await fetchPredict(pr, el('mode').value);
    renderResult(pr, data);
  }

  function startAuto(){
    const sec = Math.max(5, parseInt(el('autoEvery').value||'30',10));
    clearInterval(autoTimer);
    autoTimer=setInterval(()=>{
      const cur = el('period').value.trim();
      if(/^\d+$/.test(cur)) el('period').value = (BigInt(cur)+1n).toString();
      runPredict();
    }, sec*1000);
  }

  el('btnPredict').addEventListener('click', runPredict);
  el('period').addEventListener('keydown', e=>{ if(e.key==='Enter') runPredict(); });
  el('btnClear').addEventListener('click', ()=>{
    clearInterval(autoTimer); autoTimer=null; el('autoNext').checked=false;
    el('period').value=''; el('periodInfo').textContent='‚Äî'; el('resultCard').style.display='none'; el('hist').textContent='‚Äî';
    if(probChart){ probChart.destroy(); probChart=null; } if(bsChart){ bsChart.destroy(); bsChart=null; }
    el('apiStatus').textContent='Engine: idle';
  });
  el('btnCopy').addEventListener('click', async ()=>{
    const n=el('vNum').textContent; if(!n||n==='‚Äî'){ alert('‡§™‡§π‡§≤‡•á Predict ‡§ï‡§∞‡•á‡§Ç'); return; }
    const txt=`Period: ${el('vPeriod').textContent}, Number: ${el('vNum').textContent}, Size: ${el('vSize').textContent}, Big:${el('vBig').textContent}, Small:${el('vSmall').textContent}`;
    try{ await navigator.clipboard.writeText(txt); alert('Copied!'); }catch{ alert('Copy failed'); }
  });
  el('autoNext').addEventListener('change', e=>{ clearInterval(autoTimer); autoTimer=null; if(e.target.checked) startAuto(); });
  el('notifyBtn').addEventListener('click', async ()=>{
    if(!('Notification' in window)) { alert('Notifications not supported'); return; }
    if(Notification.permission==='granted'){ alert('Notifications already enabled'); return; }
    try{ await Notification.requestPermission(); alert('Done'); }catch(_){}
  });
  el('compactToggle').addEventListener('change', e=>{ if(e.target.checked) root.classList.add('compact'); else root.classList.remove('compact'); });
});
</script>
</body>
</html>
